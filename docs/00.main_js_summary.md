# `main.js` Functionality and Design Summary

## 1. Introduction

This document provides a summary of the functionality and design of the `main.js` file for the game "Cookie Clicker". The file is a comprehensive JavaScript program that encapsulates the entire game's logic, rendering, and data management.

## 2. Overall Design

The game is architected around a single global object, `Game`, which acts as a namespace for all game-related properties and methods. This design, common in web games of its era, keeps the global scope clean and organizes the code into a single, large module.

The program follows an event-driven model, with a central game loop (`Game.Loop`) that updates at a fixed framerate.

Key design features include:
- **Single Global Object:** All game logic is contained within the `Game` object.
- **Game Loop:** A `setInterval`-based loop for consistent updates.
- **Extensive Helper Functions:** A large library of utility functions for common tasks.
- **Data-Driven Content:** Game elements like buildings, upgrades, and achievements are stored in data structures, making them easier to manage and extend.
- **Robust Modding API:** A dedicated API allows for deep and extensive modification of the game's behavior.
- **Comprehensive Localization:** A flexible system for translating the game into multiple languages.

## 3. Core Components

### 3.1. Game Initialization (`Game.Launch` & `Game.Init`)

- **`Game.Launch()`:** This is the entry point. It performs initial setup, such as detecting the environment (mobile, web), preloading critical assets (like golden cookie images), and setting up event listeners.
- **`Game.Init()`:** Called after essential assets are loaded. This function initializes the main game state. It sets up all game variables, defines buildings, upgrades, and achievements, resets game timers, and populates the game world. It concludes by loading a save from `localStorage` (if one exists) and starting the main game loop.

### 3.2. Main Game Loop (`Game.Loop`)

The game's heart is the `Game.Loop` function, which is set to run at a target of 30 frames per second. On each tick, it performs the following actions:
- **Logic (`Game.Logic()`):**
    - Calculates elapsed time to handle variable frame rates.
    - Updates timers for buffs, seasons, and other time-sensitive events.
    - Manages the spawning and behavior of shimmers (Golden Cookies, Reindeer).
    - Updates the news ticker.
    - Recalculates Cookies Per Second (CpS) if necessary.
    - Adds cookies based on the current CpS.
    - Checks for unlock conditions for new upgrades and achievements.
- **Drawing (`Game.Draw()`):**
    - Redraws all visual elements on the screen, including the big cookie, building list, upgrade store, and stats panels.
    - Updates numbers and text to reflect the current game state.
    - Renders particles and other visual effects.

### 3.3. Data Management (Save/Load)

- **Saving:** The game state is saved to the browser's `localStorage`. The `Game.WriteSave()` function gathers all relevant data (cookies, buildings owned, upgrades unlocked, etc.), serializes it into a custom string format, and encodes it using a custom Base64 function (`utf8_to_b64`).
- **Loading:** `Game.LoadSave()` reads the encoded string from `localStorage`, decodes it, and parses it to restore the game state. It includes version-checking to handle data from previous game versions.
- **Import/Export:** The game provides functionality to export the save string to a text file and import it back, allowing players to back up their progress.

### 3.4. Localization (`loc`)

The game features a sophisticated localization system to support multiple languages.
- **`Langs` Object:** Defines all supported languages and their properties.
- **`loc(id, params)` function:** This is the core translation function. It takes a string ID and optional parameters and returns the correctly translated and formatted string for the current language.
- **Pluralization:** The system supports complex pluralization rules, which are defined per-language.
- **Language Files:** Language data is loaded dynamically as JSON files.

### 3.5. Modding API

A powerful and flexible API allows developers to create mods that can significantly alter the game.
- **`Game.registerMod(id, modObject)`:** Registers a new mod, providing it with `init`, `save`, and `load` methods.
- **`Game.registerHook(hook, func)`:** This is the primary mechanism for modding. Mods can "hook" into various game events to execute custom code. Key hooks include:
    - `cps`: Modify the calculated CpS.
    - `cookiesPerClick`: Modify the number of cookies earned per click.
    - `draw`: Execute code on every draw frame.
    - `logic`: Execute code on every logic frame.
    - `reset`: Run code when the player ascends or resets.
    - `create`: Declare custom upgrades and achievements.

## 4. Key Functionality

### 4.1. Core Gameplay

- **Cookie Production:** The primary goal is to produce cookies. This is done by clicking the big cookie and by purchasing buildings that automatically generate cookies over time.
- **Buildings:** These are the primary automated cookie generators. Each building has a base CpS, which can be improved with upgrades.
- **Upgrades:** Players can purchase upgrades to increase clicking power, boost the output of specific buildings, or unlock new game mechanics. Upgrades are organized into tiers and are a key driver of progression.

### 4.2. Random Events (Shimmers)

- **Golden Cookies:** These appear randomly on screen. Clicking them grants a temporary buff, such as a massive increase in CpS ("Frenzy") or instant cookies.
- **Wrath Cookies:** During the "Grandmapocalypse" event, Golden Cookies are replaced by Wrath Cookies, which have a chance of applying a negative or a more powerful positive effect.
- **Reindeer:** During the Christmas season, reindeer fly across the screen and can be clicked for a large number of cookies.

### 4.3. Minigames

Certain buildings, when leveled up with Sugar Lumps, unlock complex minigames that provide unique boosts and rewards. The `main.js` file contains the logic for managing these minigames. Examples include:
- **The Grimoire (Wizard Towers):** A magic system for casting spells.
- **The Pantheon (Temples):** A system for slotting spirits to gain passive buffs.
- **The Garden (Farms):** A crop-hybridization game for unlocking special plants and permanent boosts.
- **The Stock Market (Banks):** A simulation for buying and selling goods.
