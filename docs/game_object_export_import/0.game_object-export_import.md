# Cookie Clicker Import/Export Functionality

## 1. Introduction

This document details the technical implementation of the import and export functionality in `main.js`. This feature is critical for players to back up their progress, move saves between different browsers or computers, and recover lost data.

## 2. Export Process

The export process is initiated when the player chooses to save their game to a file. The core of this process is the `Game.WriteSave()` function, which serializes the entire game state into a single string, which is then encoded and provided to the user.

### 2.1. Data Serialization (`Game.WriteSave()`)

1.  **Data Aggregation:** The function gathers all critical game variables into a large array. This includes:
    -   Game version
    -   Player stats (cookies, cookies baked, start date, etc.)
    -   Game settings and preferences (e.g., volume, graphics settings)
    -   The number of each building owned and bought.
    -   A binary string representing which upgrades have been unlocked.
    -   A binary string representing which achievements have been earned.
    -   State of various minigames (Grimoire, Pantheon, Garden, etc.).
    -   Information about active buffs, seasons, and the cookie dragon.

2.  **String Concatenation:** The array of data is joined into a single string, with each piece of data separated by a `|` (pipe) character.

3.  **Mod Data:** The `Game.saveModData()` function is called. It iterates through all registered mods and, if a mod has a `save()` method, it calls it. The returned data is appended to the main save string, with each mod's data prefixed by its ID and escaped to prevent delimiter conflicts (using `Game.safeSaveString`).

### 2.2. Encoding and File Generation

1.  **Base64 Encoding:** The entire serialized string is encoded using the custom `utf8_to_b64()` function. This function is specifically designed to correctly handle UTF-8 characters, preventing data corruption that can occur with the standard `btoa()` function.

2.  **Termination String:** A control string, `!END!`, is appended to the end of the Base64-encoded data. This acts as a simple integrity check to ensure the entire save string was copied correctly.

3.  **File Download:** The final string is passed to the `saveAs` utility, which creates a `.txt` file containing the save data and prompts the user to download it.

## 3. Import Process

The import process begins when a player pastes their save string into the import prompt. The `Game.LoadSave()` function is responsible for parsing this string and restoring the game state.

### 3.1. Decoding and Validation

1.  **Initial Check:** The function first checks for the presence of the `!END!` string. If it's missing, the import is likely to fail, but the process continues.

2.  **Base64 Decoding:** The input string is decoded using the corresponding `b64_to_utf8()` function, which safely converts the Base64 data back into the original UTF-8 save string.

### 3.2. Data Parsing and State Restoration

1.  **Splitting the String:** The decoded string is split by the `|` delimiter, creating an array of data points that mirrors the one created during the save process.

2.  **Version Check:** The first element of the array is the game version from which the save originated. The game uses this to handle saves from older versions, applying compatibility logic to prevent bugs and correctly migrate data to the current structure.

3.  **Populating Game State:** The function iterates through the data array, parsing each value and assigning it to its corresponding variable within the `Game` object. This includes:
    -   Parsing numbers for cookie counts and building amounts.
    -   Uncompressing binary strings for upgrades and achievements.
    -   Restoring settings and preferences.

4.  **Loading Mod Data:** The save string is checked for mod data. If found, the data is parsed, and for each mod present in the save, its `load()` method is called with the relevant data string. This allows mods to restore their own persistent state.

5.  **Post-Load Initialization:** After all data has been parsed, the game performs a series of re-initialization steps. This includes recalculating the CpS, updating the display of all buildings and upgrades, and refreshing the news ticker to ensure the game state is consistent and accurately reflects the loaded data.
