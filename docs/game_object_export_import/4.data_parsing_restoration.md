# Cookie Clicker: Data Parsing and State Restoration

## 1. Introduction

This document provides a detailed analysis of the data parsing and state restoration process in Cookie Clicker, as implemented in the `Game.LoadSave` function. This is the second major phase of the import process, occurring immediately after the raw save string has been decoded from Base64. Its purpose is to read the structured, plain-text save data and use it to populate all the relevant variables and objects in the live game, effectively restoring the player's progress.

## 2. The Splitting Phase: Deconstructing the Save String

After decoding, the `data` variable holds the entire game state as a single string. The first step is to deconstruct this string into its constituent parts using delimiters.

### 2.1. The Primary Delimiter: `|`

The primary delimiter used to separate the major sections of the save file is the pipe character (`|`). The code splits the string into a top-level array, which is then used to access each main section by its index.

```javascript
str=str.split('|');
version=parseFloat(str[0]);
```

The resulting `str` array is structured as follows:

-   `str[0]`: Game version number.
-   `str[1]`: An empty, reserved section for future use.
-   `str[2]`: Run details (start date, bakery name, seed, etc.).
-   `str[3]`: A compressed bitfield for player preferences.
-   `str[4]`: The largest section, containing dozens of miscellaneous game state variables.
-   `str[5]`: Building data.
-   `str[6]`: Upgrade data (in a compressed format).
-   `str[7]`: Achievement data (in a compressed format).
-   `str[8]`: Data for active buffs.
-   `str[9]`: Mod data.

### 2.2. Secondary Delimiters: `;` and `,`

Within each major section, other delimiters are used:

-   **Semicolon (`;`)**: This is the most common secondary delimiter. It is used to separate individual data points within a section. For example, `str[2]` is split by `;` to get the `startDate`, `fullDate`, `bakeryName`, etc.
-   **Comma (`,`)**: This is used for data points that are themselves arrays or composite values. For example, in the building data section (`str[5]`), each building's data is a comma-separated list of its amount, total cookies made, level, and more.

## 3. State Restoration: Populating Game Variables

Once the string is split, the function proceeds section by section, parsing each value and assigning it to its corresponding variable in the `Game` object.

### 3.1. Section 2: Run Details

This section restores basic information about the player's run.

```javascript
spl=str[2].split(';');//save stats
Game.startDate=parseInt(spl[0]);
Game.fullDate=parseInt(spl[1]);
Game.lastDate=parseInt(spl[2]);
var bakeryName=(spl[3]?spl[3]:Game.GetBakeryName());
Game.seed=spl[4]?spl[4]:Game.makeSeed();
Game.YouCustomizer.load(spl[5]||0);
```

### 3.2. Section 4: Miscellaneous Game Data

This is the most extensive section, containing the bulk of the gameplay state. The code splits `str[4]` by the semicolon (`;`) and assigns each value to its corresponding variable. The following is a comprehensive list of these variables:

| Index | Variable Name             | Parsing Method   | Description                                               |
|-------|---------------------------|------------------|-----------------------------------------------------------|
| 0     | `Game.cookies`            | `parseFloat`     | The player's current number of cookies.                   |
| 1     | `Game.cookiesEarned`      | `parseFloat`     | Total cookies earned in the current ascension.            |
| 2     | `Game.cookieClicks`       | `parseInt`       | Total clicks on the big cookie across all ascensions.     |
| 3     | `Game.goldenClicks`       | `parseInt`       | Total golden cookie clicks across all ascensions.         |
| 4     | `Game.handmadeCookies`    | `parseFloat`     | Total cookies baked by clicking.                          |
| 5     | `Game.missedGoldenClicks` | `parseInt`       | Total number of golden cookies that despawned.            |
| 6     | `Game.bgType`             | `parseInt`       | The ID of the selected milk background.                   |
| 7     | `Game.milkType`           | `parseInt`       | The ID of the selected milk type.                         |
| 8     | `Game.cookiesReset`       | `parseFloat`     | Total cookies baked across all ascensions (used for prestige). |
| 9     | `Game.elderWrath`         | `parseInt`       | The current stage of the Grandmapocalypse.                |
| 10    | `Game.pledges`            | `parseInt`       | The number of times the Elder Pledge has been purchased.    |
| 11    | `Game.pledgeT`            | `parseInt`       | The time remaining on the current Elder Pledge.           |
| 12    | `Game.nextResearch`       | `parseInt`       | The ID of the research currently in progress.             |
| 13    | `Game.researchT`          | `parseInt`       | The time remaining on the current research.               |
| 14    | `Game.resets`             | `parseInt`       | The total number of times the player has ascended.        |
| 15    | `Game.goldenClicksLocal`  | `parseInt`       | Golden cookie clicks in the current ascension.            |
| 16    | `Game.cookiesSucked`      | `parseFloat`     | Total cookies withered by Wrinklers.                      |
| 17    | `Game.wrinklersPopped`    | `parseInt`       | Total number of Wrinklers popped.                         |
| 18    | `Game.santaLevel`         | `parseInt`       | The current level of Santa.                               |
| 19    | `Game.reindeerClicked`    | `parseInt`       | Total number of reindeer clicked.                         |
| 20    | `Game.seasonT`            | `parseInt`       | Time remaining on the current seasonal event.             |
| 21    | `Game.seasonUses`         | `parseInt`       | Number of times the season switcher has been used.        |
| 22    | `Game.season`             | (string)         | The name of the current season (e.g., 'christmas').       |
| 23,24 | (wrinklers)               | `parseFloat`     | Wrinkler data (amount and number), handled separately.    |
| 25    | `Game.prestige`           | `parseFloat`     | The player's current prestige level.                      |
| 26    | `Game.heavenlyChips`      | `parseFloat`     | Current unspent Heavenly Chips.                           |
| 27    | `Game.heavenlyChipsSpent` | `parseFloat`     | Total Heavenly Chips spent on upgrades.                   |
| 28    | `Game.heavenlyCookies`    | `parseFloat`     | Total cookies baked across all ascensions (legacy).       |
| 29    | `Game.ascensionMode`      | `parseInt`       | The ID of the current challenge mode (0 for none).        |
| 30-34 | `Game.permanentUpgrades`  | `parseInt`       | The 5 upgrade IDs slotted for permanent unlocks.          |
| 35    | `Game.dragonLevel`        | `parseInt`       | The current level of the Krumblor dragon.                 |
| 36    | `Game.dragonAura`         | `parseInt`       | The ID of the first selected dragon aura.                 |
| 37    | `Game.dragonAura2`        | `parseInt`       | The ID of the second selected dragon aura.                |
| 38    | `Game.chimeType`          | `parseInt`       | The ID of the golden cookie sound effect.                 |
| 39    | `Game.volume`             | `parseInt`       | The master volume level (0-100).                          |
| 40,41 | (shiny wrinklers)         | `parseInt`       | Shiny wrinkler data (number and amount).                  |
| 42    | `Game.lumps`              | `parseFloat`     | The current number of sugar lumps.                        |
| 43    | `Game.lumpsTotal`         | `parseFloat`     | Total sugar lumps ever harvested.                         |
| 44    | `Game.lumpT`              | `parseInt`       | The timestamp for when the current lump will be ripe.     |
| 45    | `Game.lumpRefill`         | `parseInt`       | Timestamp for when a minigame can be refilled again.      |
| 46    | `Game.lumpCurrentType`    | `parseInt`       | The type of the currently growing sugar lump.             |
| 47    | `Game.vault`              | `split(',')`     | An array of upgrade IDs stored in the Vault.              |
| 48    | `Game.heralds`            | `parseFloat`     | The number of Heralds active.                             |
| 49,50 | `Game.fortuneGC/CPS`      | `parseInt`       | Data for fortune cookie outcomes.                         |
| 51    | `Game.cookiesPsRawHighest`| `parseFloat`     | The highest raw CpS achieved this ascension.              |
| 52    | `Game.volumeMusic`        | `parseInt`       | The music volume level (0-100).                           |
| 53,54 | `Game.cookiesSent/Received`| `parseInt`      | Cookies sent/received via the trading feature.            |

### 3.3. Section 5: Building Data

This section restores the state of each building. The code iterates through all defined game objects (`Game.ObjectsById`) and uses the index to find the corresponding data in the `spl` array.

```javascript
spl=str[5].split(';');//buildings
for (var i in Game.ObjectsById)
{
    var me=Game.ObjectsById[i];
    if (spl[i])
    {
        var mestr=spl[i].toString().split(',');
        me.amount=parseInt(mestr[0]);
        me.bought=parseInt(mestr[1]);
        me.totalCookies=parseFloat(mestr[2]);
        me.level=parseInt(mestr[3]||0);
        //...
        if (me.minigame && me.minigameLoaded) {me.minigame.load(mestr[4]||'');}
    }
}
```

### 3.4. Sections 6 & 7: Upgrades and Achievements

This data is stored as a compressed binary string. The code first uncompresses the string and then iterates through all upgrades/achievements, checking the corresponding bit in the string to determine if it has been bought or won.

```javascript
//Upgrades
spl=str[6];
spl=(spl).split('');
for (var i in Game.UpgradesById)
{
    var me=Game.UpgradesById[i];
    if (spl[i*2])
    {
        var mestr=[spl[i*2],spl[i*2+1]];
        me.unlocked=parseInt(mestr[0]);
        me.bought=parseInt(mestr[1]);
    }
}
```

## 4. Post-Load Initialization

After all the raw data has been loaded into the game's variables, the state is not yet fully consistent or playable. A series of finalization steps are required:

1.  **Minigame Loading:** `Game.LoadMinigames()` is called to ensure any minigames that should be active are properly initialized with their saved data.
2.  **Wrinkler Restoration:** `Game.ResetWrinklers()` and `Game.LoadWrinklers()` are called to respawn any active wrinklers from the previous session.
3.  **Offline Progress Calculation:** The game calculates the time elapsed since the last save (`timeOffline`) and computes the cookies earned during that period, adding them to the player's total.
4.  **Buff Restoration:** Active buffs from the save file are recreated using `Game.gainBuff()`.
5.  **UI and Calculation Refresh:** Finally, functions like `Game.CalculateGains()`, `Game.RebuildUpgrades()`, and `Game.bakeryNameRefresh()` are called to update all calculations (CpS, etc.) and refresh the user interface to reflect the newly loaded state.
