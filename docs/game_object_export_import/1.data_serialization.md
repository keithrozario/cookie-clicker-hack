# Cookie Clicker Data Serialization

## 1. Introduction

This document provides a detailed breakdown of the data serialization process as implemented in the `Game.WriteSave()` function in `main.js`. This process is responsible for converting the current game state into a single, portable string for exporting and saving.

## 2. The `Game.WriteSave()` Function

The serialization process is handled entirely by the `Game.WriteSave()` function. It systematically gathers all relevant game data, concatenates it into a structured string, and prepares it for encoding.

```javascript
Game.WriteSave=function(type)
{
    Game.toSave=false;
    //type: none is default, 1=return string only, 2=return uncompressed string, 3=return uncompressed, commented string
    Game.lastDate=parseInt(Game.time);
    var str='';
    //...
```

## 3. Data Aggregation

Data aggregation is the first major step. The function collects hundreds of data points that define the current game state. These are added sequentially to a string variable, `str`.

The data is grouped into logical sections, with each piece of data being appended to the string followed by a delimiter.

### 3.1. Core Game and Player Data

This section includes general information about the current run and the player's preferences.

-   `Game.version`: The version of the game the save was created in.
-   `Game.startDate`: Timestamp of when the current run began.
-   `Game.fullDate`: Timestamp of when the player first started playing (legacy start).
-   `Game.lastDate`: Timestamp of when the game was last saved.
-   `Game.bakeryName`: The player's chosen bakery name.
-   `Game.seed`: The random seed for the current run.
-   `Game.YouCustomizer.save()`: Serialized data for the player's custom avatar.

### 3.2. Preferences

Player preferences are packed into a binary string (a bitfield) where '1' represents `true` and '0' represents `false`. This is a space-saving measure.

```javascript
var str2=//prefs
(
    Game.prefs.particles?'1':'0')+
    (Game.prefs.numbers?'1':'0')+
    (Game.prefs.autosave?'1':'0')+
    //... and so on for all preferences
'';
str2=pack3(str2);
str+=str2+'|';
```

### 3.3. Miscellaneous Game State Variables

This is the largest and most detailed section, containing the core gameplay variables.

-   **Cookies & Clicks**
    -   `Game.cookies`: Current number of cookies.
    -   `Game.cookiesEarned`: Total cookies earned in this run.
    -   `Game.cookieClicks`: Total number of clicks on the big cookie.
    -   `Game.goldenClicks`: Total number of golden cookie clicks.
    -   `Game.handmadeCookies`: Total cookies generated by clicking.
    -   `Game.missedGoldenClicks`: Total number of missed golden cookies.
-   **Prestige & Ascension**
    -   `Game.cookiesReset`: Total cookies forfeited by ascending.
    -   `Game.resets`: Number of times the player has ascended.
    -   `Game.prestige`: Current prestige level.
    -   `Game.heavenlyChips`: Current number of heavenly chips.
    -   `Game.heavenlyChipsSpent`: Total heavenly chips spent.
    -   `Game.heavenlyCookies`: Total heavenly cookies earned across all runs.
    -   `Game.ascensionMode`: The current challenge mode (e.g., 'Born Again').
    -   `Game.permanentUpgrades`: An array of 5 IDs for upgrades slotted to be permanent.
-   **Game Mechanics**
    -   `Game.elderWrath`: The current state of the Grandmapocalypse.
    -   `Game.pledges`: Number of times the Elder Pledge has been made.
    -   `Game.pledgeT`: Time remaining on the current pledge.
    -   `Game.researchT`: Time remaining on the current research.
    -   `Game.santaLevel`: The current level of Santa.
    -   `Game.dragonLevel`: The current level of the Krumblor dragon.
    -   `Game.dragonAura` & `Game.dragonAura2`: The selected dragon auras.
    -   `Game.lumps`: Current number of sugar lumps.
    -   `Game.lumpT`: Timestamp for when the current sugar lump will mature.
-   **And many more**, including data for wrinklers, seasons, fortunes, and minigames.

### 3.4. Buildings, Upgrades, and Achievements

Data for buildings, upgrades, and achievements is serialized in a highly compressed format.

-   **Buildings:** For each building, the amount owned, total cookies made, and minigame level are saved.
-   **Upgrades:** A binary string is generated, where each position corresponds to an upgrade's ID. A '1' means the upgrade is unlocked, and a '0' means it is not. This string is then compressed.
-   **Achievements:** Similar to upgrades, a compressed binary string is used to store which achievements have been earned.

```javascript
// Example of creating the binary string for upgrades
var str2='';
for (var i in Game.UpgradesById) {str2+=(Game.UpgradesById[i].unlocked?'1':'0');}
str2=CompressLargeBin(str2);
str+=str2+'|';
```

## 4. String Concatenation

As the data is aggregated, it is concatenated into a single string. The function uses two primary delimiters:

-   **`|` (Pipe):** This is the main delimiter used to separate major sections of the save file (e.g., core data, preferences, building data, upgrade data).
-   **`;` (Semicolon):** This is a secondary delimiter used within major sections to separate individual data points (e.g., `Game.cookies;Game.cookiesEarned;...`).

This two-level structure allows for organized parsing of the save file upon import.

## 5. Mod Data Integration

After all vanilla game data has been serialized, the game integrates data from any active mods.

1.  **`Game.saveModData()`:** This function is called to generate the mod data string.
2.  **Iterating Mods:** It loops through all registered mods.
3.  **Calling `save()`:** If a mod has a `save()` method, it is invoked. This method is expected to return a string containing all the data the mod needs to persist.
4.  **Escaping and Appending:** The returned string is escaped using `Game.safeSaveString()` to replace any `|` or `;` characters, preventing them from conflicting with the main save format. The mod's ID and its escaped data are then appended to the main save string.

```javascript
Game.saveModData=function()
{
    var str='';
    for (var i=0;i<Game.sortedMods.length;i++)
    {
        if (Game.sortedMods[i]['save'])
        {
            var data=Game.sortedMods[i]['save']();
            if (typeof data!=='undefined') Game.modSaveData[Game.sortedMods[i].id]=data;
        }
    }
    for (var i in Game.modSaveData)
    {
        str+=i+':'+Game.safeSaveString(Game.modSaveData[i])+';';
    }
    if (App && App.saveMods) str+=App.saveMods();
    return str;
}
```

This entire process results in a single, long, structured string that represents the complete state of the game, ready to be encoded and exported.
